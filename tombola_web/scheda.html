<!doctype html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <title>Scheda Tombola</title>
    <style>
      body {
        font-family: Arial;
        text-align: center;
        padding: 2rem;
      }
      .board {
        display: grid;
        grid-template-rows: repeat(3, 60px);
        grid-template-columns: repeat(9, 60px);
        gap: 5px;
        justify-content: center;
      }
      .cell {
        width: 60px;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid #ccc;
        cursor: pointer;
      }
      .selected {
        background-color: #90ee90;
      }
      button {
        margin: 0.5rem;
        padding: 0.5rem 1rem;
      }
    </style>
  </head>
  <body>
    <h2>Scheda di <span id="user"></span></h2>
    <div class="board" id="board"></div>

    <div style="margin-top: 2rem">
      <button onclick="sendWin('Ambo')">Ambo</button>
      <button onclick="sendWin('Terno')">Terno</button>
      <button onclick="sendWin('Quaterna')">Quaterna</button>
      <button onclick="sendWin('Cinquina')">Cinquina</button>
      <button onclick="sendWin('Tombola')">Tombola</button>
    </div>

    <p id="message" style="margin-top: 1rem; font-weight: bold"></p>

    <script>
      
      
      const serverUrl = localStorage.getItem('serverUrl');
      const username = localStorage.getItem('username');



      document.getElementById('user').textContent = username;

      const board = document.getElementById('board');
      const selected = [];
      const usedNumbers = new Set();

      // Decine
      const decine = [
        Array.from({ length: 9 }, (_, i) => i + 1), // 1-9
        Array.from({ length: 10 }, (_, i) => i + 10), // 10-19
        Array.from({ length: 10 }, (_, i) => i + 20), // 20-29
        Array.from({ length: 10 }, (_, i) => i + 30), // 30-39
        Array.from({ length: 10 }, (_, i) => i + 40), // 40-49
        Array.from({ length: 10 }, (_, i) => i + 50), // 50-59
        Array.from({ length: 10 }, (_, i) => i + 60), // 60-69
        Array.from({ length: 10 }, (_, i) => i + 70), // 70-79
        Array.from({ length: 11 }, (_, i) => i + 80), // 80-90
      ];

      // Funzione principale da eseguire onload
      function initCard() {
        const usedNumbers = new Set();
        const card = [];

        for (let r = 0; r < 3; r++) {
          const row = Array(9).fill(null);
          const chosenCols = [];
          // scegli 5 colonne uniche
          while (chosenCols.length < 5) {
            const col = Math.floor(Math.random() * 9);
            if (!chosenCols.includes(col)) chosenCols.push(col);
          }
          chosenCols.forEach((col) => {
            let num;
            do {
              num = decine[col][Math.floor(Math.random() * decine[col].length)];
            } while (usedNumbers.has(num));
            usedNumbers.add(num);
            row[col] = num;
          });
          card.push(row.filter((n) => n !== null));
        }

        // Render scheda
        card.forEach((row, r) => {
          for (let c = 0; c < 9; c++) {
            const cell = document.createElement('div');
            cell.className = 'cell';
            const num = row.find((n) => Math.floor(n / 10) === c);
            cell.textContent = num ? num : '';
            if (num) {
              cell.onclick = () => {
                if (selected.includes(num)) {
                  selected.splice(selected.indexOf(num), 1);
                  cell.classList.remove('selected');
                } else {
                  selected.push(num);
                  cell.classList.add('selected');
                }
              };
            }
            board.appendChild(cell);
          }
        });

        // ðŸ”¹ Invoca /join una sola volta
        fetch(serverUrl + '/join', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, card }),
        })
          .then((res) => res.json())
          .then((data) => {
            const msg = document.getElementById('message');
            if (data.error) {
              msg.style.color = 'red';
              msg.textContent = 'Errore registrazione: ' + data.error;
            } else {
              msg.style.color = 'green';
              msg.textContent = 'Registrazione avvenuta con successo!';
            }
          })
          .catch(() => {
            const msg = document.getElementById('message');
            msg.style.color = 'red';
            msg.textContent = 'Errore di connessione al server';
          });
      }

      // Invoca initCard solo al caricamento della pagina
      window.onload = initCard;

      // Invio vincita
      function sendWin(type) {
        fetch(serverUrl + '/checkWin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, numbers: selected }),
        })
          .then((res) => res.json())
          .then((data) => {
            const msg = document.getElementById('message');
            if (data.error) {
              msg.style.color = 'red';
              msg.textContent = 'Errore: ' + data.error;
            } else {
              msg.style.color = 'green';
              msg.textContent = 'Vincita registrata: ' + data.type;
            }
          })
          .catch(() => {
            const msg = document.getElementById('message');
            msg.style.color = 'red';
            msg.textContent = 'Errore di connessione al server';
          });
      }
    </script>
  </body>
</html>
